<div class="modal-overlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000;">
  <div class="modal-content" style="background:#112240;padding:2rem;border-radius:8px;max-width:500px;width:100%;border:1px solid #64ffda;">
    <h3 style="color:#64ffda;margin-bottom:1.5rem;">Connect Your Email Account</h3>
    
    <!-- Display detected settings -->
    <div style="background:rgba(10,25,47,0.7); padding:1rem; border-radius:8px; margin-bottom:1.5rem; border-left:3px solid #64ffda;">
      <h4 style="color:#64ffda; margin-bottom:0.5rem;">Detected Settings</h4>
      <p style="color:#8892b0; margin:0.25rem 0;">
        <strong>Email:</strong> {{ email }}
      </p>
      <p style="color:#8892b0; margin:0.25rem 0;">
        <strong>SMTP Server:</strong> {{ smtp_host }}:{{ smtp_port }}
      </p>
      <p style="color:#8892b0; margin:0.25rem 0;">
        <strong>IMAP Server:</strong> {{ imap_host }}:{{ imap_port }}
      </p>
    </div>
    
    <!-- Error display container -->
    <div id="error-container" style="color: #ff6b6b; margin-bottom: 1rem; display: none;"></div>
    
    <!-- Success message container -->
    <div id="success-container" style="color: #64ffda; margin-bottom: 1rem; display: none;"></div>
    
    <form method="POST" 
          action="/connect-smtp" 
          hx-post="/connect-smtp"
          hx-target=".modal-overlay"
          hx-swap="outerHTML"
          enctype="application/x-www-form-urlencoded">
          
      <input type="hidden" name="user_id" value="{{ user_id }}">
      <input type="hidden" name="smtp_email" value="{{ email }}">
      <input type="hidden" name="smtp_host" value="{{ smtp_host }}">
      <input type="hidden" name="imap_host" value="{{ imap_host }}">
      <input type="hidden" name="smtp_port" value="{{ smtp_port }}">
      <input type="hidden" name="imap_port" value="{{ imap_port }}">
      
      <div class="form-group" style="margin-bottom:1.5rem;">
        <label style="display:block;margin-bottom:0.5rem;color:#8892b0;">App Password</label>
        <input type="password" name="smtp_password" required 
               placeholder="Enter your app password" 
               style="width:100%;padding:0.75rem;background:rgba(255,255,255,0.1);border:1px solid #64ffda;border-radius:4px;color:white;font-size:1rem;">
        <p style="color:#8892b0; font-size:0.8rem; margin-top:0.5rem;">
          For Gmail, you need to generate an app password from your Google Account settings.
          For other providers, use your email password or app-specific password.
        </p>
      </div>
      <a href="https://myaccount.google.com/apppasswords" target="_blank" class="google-link">create an app password â†’</a>
      <div style="display:flex;justify-content:flex-end;gap:0.5rem;">
        <button type="button" 
                style="padding:0.75rem 1.5rem;background:transparent;border:1px solid #f72585;color:#f72585;border-radius:4px;"
                hx-get="/dashboard/settings?user_id={{ user_id }}"
                hx-target=".modal-overlay"
                hx-swap="outerHTML">
          Cancel
        </button>
        <button type="submit" 
                style="padding:0.75rem 1.5rem;background:#64ffda;color:#0a192f;border:none;border-radius:4px;font-weight:bold;">
          Connect Account
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('htmx:afterRequest', function(event) {
    // Check if the request was to the connect-smtp endpoint
    if (event.detail.pathInfo.requestPath.includes('/connect-smtp')) {
      const errorContainer = document.getElementById('error-container');
      const successContainer = document.getElementById('success-container');
      
      // Hide previous messages
      errorContainer.style.display = 'none';
      successContainer.style.display = 'none';
      
      if (event.detail.failed) {
        try {
          const response = JSON.parse(event.detail.xhr.responseText);
          errorContainer.textContent = response.message || 'An error occurred while connecting your account';
          errorContainer.style.display = 'block';
        } catch (e) {
          errorContainer.textContent = 'Error: ' + (event.detail.xhr.statusText || 'Unknown error occurred');
          errorContainer.style.display = 'block';
        }
      } else if (event.detail.xhr.status >= 200 && event.detail.xhr.status < 300) {
        // Success - check response type
        try {
          const response = JSON.parse(event.detail.xhr.responseText);
          
          if (response.redirect) {
            // Redirect to specified URL
            window.location.href = response.redirect;
          } else if (response.message) {
            // Show success message
            successContainer.textContent = response.message;
            successContainer.style.display = 'block';
            
            // Redirect to dashboard after 2 seconds
            setTimeout(() => {
              window.location.href = '/dashboard'; // Change to your preferred destination
            }, 2000);
          }
        } catch (e) {
          // If response is not JSON, assume success and redirect
          successContainer.textContent = 'Account connected successfully! Redirecting...';
          successContainer.style.display = 'block';
          
          setTimeout(() => {
            window.location.href = '/dashboard'; // Change to your preferred destination
          }, 2000);
        }
      } else {
        // Handle other status codes
        errorContainer.textContent = 'Error: ' + event.detail.xhr.status + ' - ' + event.detail.xhr.statusText;
        errorContainer.style.display = 'block';
      }
    }
  });
</script>
