<div class="manual-email-section">
    <h1>Manual Email Reply <i class="fas fa-keyboard"></i></h1>
    <p class="subtitle">Paste email content for AI to generate responses and follow-up sequences</p>

    <div class="manual-email-container">
        <!-- Email Input Section -->
        <div class="email-form-card">
            <h3><i class="fas fa-envelope"></i> Paste Email Content</h3>
            
            <form id="manualEmailForm" class="email-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="sender_email">Sender Email *</label>
                        <input type="email" id="sender_email" name="sender_email" 
                               placeholder="lead@example.com" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="sender_name">Sender Name *</label>
                        <input type="text" id="sender_name" name="sender_name" 
                               placeholder="John Smith" class="form-control" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="subject">Subject *</label>
                    <input type="text" id="subject" name="subject" 
                           placeholder="Email subject" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="email_content">Email Content *</label>
                    <textarea id="email_content" name="email_content" 
                              placeholder="Paste the email content you received from a lead or client here..."
                              rows="8" class="form-control" required></textarea>
                </div>

                <!-- Quick Templates -->
                <div class="form-group">
                    <label>Quick Templates <small>(Click to apply)</small></label>
                    <div class="template-buttons">
                        <button type="button" class="template-btn" onclick="applyTemplate('inquiry')">
                            Property Inquiry
                        </button>
                        <button type="button" class="template-btn" onclick="applyTemplate('meeting')">
                            Meeting Request
                        </button>
                        <button type="button" class="template-btn" onclick="applyTemplate('pricing')">
                            Pricing Question
                        </button>
                        <button type="button" class="template-btn" onclick="applyTemplate('followup')">
                            Follow-up Email
                        </button>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-robot"></i> Generate AI Response
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearForm()">
                        <i class="fas fa-trash"></i> Clear Form
                    </button>
                </div>
            </form>
        </div>

        <!-- Response Section -->
        <div class="response-card" id="responseCard" style="display: none;">
            <div class="response-header">
                <h3><i class="fas fa-reply"></i> AI Response</h3>
                <div class="response-status" id="responseStatus"></div>
            </div>
            
            <div class="response-content" id="responseContent">
                <!-- AI response will appear here -->
            </div>
            
            <div class="response-actions" id="responseActions">
                <button class="btn btn-primary" onclick="copyResponse()">
                    <i class="fas fa-copy"></i> Copy Response
                </button>
                <button class="btn btn-success" onclick="sendResponse()" id="sendBtn" style="display: none;">
                    <i class="fas fa-paper-plane"></i> Send via Gmail
                </button>
                <button class="btn btn-info" onclick="generateFollowUps()" id="followupBtn" style="display: none;">
                    <i class="fas fa-sync-alt"></i> Generate Follow-ups
                </button>
                <button class="btn btn-secondary" onclick="resetForm()">
                    <i class="fas fa-sync"></i> New Email
                </button>
            </div>

            <!-- Follow-up Section -->
            <div class="followup-section" id="followupSection" style="display: none;">
                <div class="followup-header">
                    <h4><i class="fas fa-calendar-alt"></i> AI-Generated Follow-up Sequence</h4>
                    <button class="btn btn-success btn-sm" onclick="saveFollowUps()" id="saveFollowupsBtn">
                        <i class="fas fa-save"></i> Save Follow-up Sequence
                    </button>
                </div>
                
                <div class="followup-list" id="followupList">
                    <!-- Follow-ups will appear here -->
                </div>
                
                <div class="followup-note">
                    <i class="fas fa-info-circle"></i>
                    Follow-ups will be scheduled automatically and sent via AI. You can review and edit them in the Leads section.
                </div>
            </div>
        </div>

        <!-- Info & Tips Section -->
        <div class="info-card">
            <h4><i class="fas fa-lightbulb"></i> How to use:</h4>
            <ul>
                <li><strong>Quick Start:</strong> Use templates for common email types</li>
                <li><strong>Better Responses:</strong> Include sender name and context</li>
                <li><strong>Follow-ups:</strong> Generate sequence after getting initial response</li>
                <li><strong>Send Options:</strong> Copy response or send directly via Gmail</li>
            </ul>
            
            <div class="tip-box">
                <strong>Pro Tip:</strong> Generate follow-ups for leads that need nurturing. 
                The AI will create a 30-day sequence of personalized follow-up emails.
            </div>

            <div class="feature-highlights">
                <h5><i class="fas fa-star"></i> Features:</h5>
                <div class="feature-item">
                    <i class="fas fa-bolt"></i>
                    <span>Instant AI Response Generation</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-sync"></i>
                    <span>Optional Follow-up Sequences</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-envelope"></i>
                    <span>Direct Gmail Integration</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Lead Tracking & Management</span>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.manual-email-section {
    animation: fadeIn 0.5s ease;
}

.subtitle {
    color: #8892b0;
    margin-bottom: 2rem;
    font-size: 1.1rem;
}

.manual-email-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    align-items: start;
}

.email-form-card,
.response-card,
.info-card {
    background: rgba(16, 36, 64, 0.6);
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid rgba(100, 255, 218, 0.2);
}

.response-card {
    grid-column: 1 / -1;
}

.info-card {
    grid-column: 1 / -1;
}

.email-form-card h3,
.response-card h3,
.info-card h4 {
    color: #64ffda;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: #ccd6f6;
    font-weight: 500;
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border-radius: 8px;
    border: 1px solid rgba(100, 255, 218, 0.3);
    background: rgba(10, 25, 47, 0.7);
    color: #fff;
    font-size: 1rem;
    font-family: inherit;
}

.form-control:focus {
    outline: none;
    border-color: #64ffda;
    box-shadow: 0 0 0 2px rgba(100, 255, 218, 0.1);
}

textarea.form-control {
    resize: vertical;
    min-height: 150px;
    font-family: inherit;
    line-height: 1.5;
}

/* Template Buttons */
.template-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.template-btn {
    padding: 0.5rem;
    border: 1px solid rgba(100, 255, 218, 0.3);
    background: rgba(100, 255, 218, 0.1);
    color: #64ffda;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.3s ease;
}

.template-btn:hover {
    background: rgba(100, 255, 218, 0.2);
    transform: translateY(-1px);
}

.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
}

/* Response Styles */
.response-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.response-status {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.status-processing {
    background: rgba(248, 150, 30, 0.2);
    color: #f8961e;
}

.status-success {
    background: rgba(100, 255, 218, 0.2);
    color: #64ffda;
}

.response-content {
    background: rgba(10, 25, 47, 0.7);
    padding: 1.5rem;
    border-radius: 8px;
    border: 1px solid rgba(100, 255, 218, 0.2);
    color: #ccd6f6;
    line-height: 1.6;
    white-space: pre-wrap;
    margin-bottom: 1.5rem;
    max-height: 400px;
    overflow-y: auto;
}

.response-actions {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

/* Follow-up Section */
.followup-section {
    border-top: 1px solid rgba(100, 255, 218, 0.2);
    padding-top: 1.5rem;
    margin-top: 1.5rem;
}

.followup-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.followup-header h4 {
    color: #64ffda;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.85rem;
}

.followup-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 1rem;
}

.followup-item {
    background: rgba(10, 25, 47, 0.5);
    border-radius: 8px;
    border: 1px solid rgba(100, 255, 218, 0.1);
    overflow: hidden;
}

.followup-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: rgba(100, 255, 218, 0.05);
    cursor: pointer;
    transition: background 0.3s ease;
}

.followup-header-row:hover {
    background: rgba(100, 255, 218, 0.1);
}

.followup-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.followup-day {
    font-weight: 600;
    color: #64ffda;
    min-width: 80px;
}

.followup-date {
    color: #8892b0;
    font-size: 0.9rem;
}

.followup-status {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.8rem;
    background: rgba(100, 255, 218, 0.1);
    color: #64ffda;
}

.followup-content {
    padding: 1rem;
    border-top: 1px solid rgba(100, 255, 218, 0.1);
    background: rgba(10, 25, 47, 0.3);
    color: #8892b0;
    line-height: 1.5;
    display: none;
}

.followup-content.expanded {
    display: block;
}

.followup-note {
    background: rgba(100, 255, 218, 0.1);
    border: 1px solid rgba(100, 255, 218, 0.2);
    border-radius: 8px;
    padding: 1rem;
    color: #64ffda;
    font-size: 0.9rem;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
}

.followup-note i {
    margin-top: 0.1rem;
}

/* Buttons */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.75rem 1.5rem;
    border-radius: 50px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(100, 255, 218, 0.3);
}

.btn-primary {
    background: linear-gradient(135deg, #64ffda 0%, #52d1b8 100%);
    color: #0a192f;
}

.btn-success {
    background: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
    color: white;
}

.btn-info {
    background: linear-gradient(135deg, #7209b7 0%, #3a0ca3 100%);
    color: white;
}

.btn-secondary {
    background: rgba(136, 146, 176, 0.2);
    color: #8892b0;
}

.btn-secondary:hover {
    background: rgba(136, 146, 176, 0.3);
    color: #ccd6f6;
}

.loading {
    opacity: 0.7;
    pointer-events: none;
}

/* Info Card Styles */
.info-card ul {
    list-style: none;
    padding: 0;
    margin: 1rem 0;
}

.info-card li {
    padding: 0.5rem 0;
    color: #8892b0;
    display: flex;
    align-items: center;
}

.info-card li:before {
    content: "âœ“";
    color: #64ffda;
    font-weight: bold;
    margin-right: 0.75rem;
}

.tip-box {
    background: rgba(100, 255, 218, 0.1);
    border: 1px solid rgba(100, 255, 218, 0.2);
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
    color: #64ffda;
}

.feature-highlights {
    margin-top: 1.5rem;
}

.feature-highlights h5 {
    color: #64ffda;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.feature-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0;
    color: #8892b0;
}

.feature-item i {
    color: #64ffda;
    width: 16px;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@media (max-width: 768px) {
    .manual-email-container {
        grid-template-columns: 1fr;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .template-buttons {
        grid-template-columns: 1fr;
    }
    
    .form-actions,
    .response-actions {
        flex-direction: column;
    }
    
    .response-header,
    .followup-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .followup-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
}
</style>

<script>
// Quick Templates
const templates = {
    inquiry: {
        subject: "Commercial Property Inquiry - [Property Name]",
        content: `Dear [Agent Name],

I came across your listing for [Property Name/Address] and would like to learn more about this opportunity.

Could you please provide me with:
- Current rent roll and occupancy rates
- Property financials and operating statements
- Recent capital improvements
- Available due diligence materials

We're actively looking for [property type] in the [area/location] market and this seems like it could be a good fit.

Thank you for your time and I look forward to hearing from you.

Best regards,
[Sender Name]
[Company Name]`
    },
    meeting: {
        subject: "Meeting Request - Property Discussion",
        content: `Hello [Agent Name],

I hope this email finds you well.

I'd like to schedule a meeting to discuss our commercial real estate needs. We're particularly interested in [property type/size] in the [location/area] market.

Would you be available for a brief call sometime next week? I'm generally free between [days/times].

Some topics I'd like to cover:
- Current market conditions in your area
- Properties that might match our criteria
- Your experience with similar transactions
- Next steps for moving forward

Please let me know what time works best for you.

Looking forward to connecting.

Sincerely,
[Sender Name]
[Title]
[Company Name]`
    },
    pricing: {
        subject: "Question About Pricing - [Property Address]",
        content: `Dear [Agent Name],

I'm writing to inquire about the pricing for [Property Address]. 

Could you help me understand:
- The current asking price and any recent adjustments
- How this compares to recent comparable sales
- Any room for negotiation or special terms
- The rationale behind the current pricing strategy

We're very interested in this property but want to ensure the numbers align with our investment criteria.

Thank you for your transparency and assistance.

Best regards,
[Sender Name]
[Company Name]`
    },
    followup: {
        subject: "Following Up on Our Previous Discussion",
        content: `Hello [Agent Name],

I hope you're having a productive week.

I wanted to follow up on our previous conversation about [topic/property]. I'm still very interested in moving forward and would appreciate an update when you have a moment.

Specifically, I'd like to know:
- Any new developments or information
- Next steps in the process
- Your availability for further discussion

Please let me know if there's any additional information I can provide from my end.

Looking forward to hearing from you.

Best regards,
[Sender Name]
[Company Name]`
    }
};

function applyTemplate(templateKey) {
    const template = templates[templateKey];
    if (template) {
        document.getElementById('subject').value = template.subject;
        document.getElementById('email_content').value = template.content;
        showNotification(`"${templateKey.replace(/_/g, ' ')}" template applied!`, 'success');
    }
}

// Main form submission
document.getElementById('manualEmailForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    submitBtn.disabled = true;
    
    try {
        const formData = new FormData(this);
        
        const response = await fetch('/dashboard/manual_email?user_id={{ user_id }}', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Email submitted for AI processing!', 'success');
            pollEmailStatus(result.email_id);
        } else {
            throw new Error(result.error || 'Failed to process email');
        }
        
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error: ' + error.message, 'error');
        resetButton();
    }
    
    function resetButton() {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});

// Enhanced polling with better status updates
async function pollEmailStatus(emailId) {
    const maxAttempts = 30;
    const interval = 2000;
    let currentAttempt = 0;
    
    // Show response card immediately
    showResponseCard('Generating AI response...', 'processing');
    
    const pollInterval = setInterval(async () => {
        currentAttempt++;
        
        try {
            const response = await fetch(`/check_manual_email_status/${emailId}?user_id={{ user_id }}`);
            
            if (!response.ok) {
                console.error(`HTTP error: ${response.status}`);
                return;
            }
            
            const result = await response.json();
            console.log('Polling result:', result);
            
            // Update status
            updateResponseStatus(result.status);
            
            // Check for completion
            const successStatuses = ['ready_to_send', 'sent', 'drafted', 'awaiting_proposal'];
            if (successStatuses.includes(result.status) || result.processed_content) {
                clearInterval(pollInterval);
                
                const content = result.processed_content || 'Response generated successfully.';
                showResponseCard(content, 'success');
                
                // Show action buttons
                document.getElementById('sendBtn').style.display = 'inline-flex';
                document.getElementById('followupBtn').style.display = 'inline-flex';
                
                resetButton();
                return;
            }
            
            if (result.status === 'error') {
                clearInterval(pollInterval);
                showResponseCard('Error: ' + (result.error_message || 'Unknown error'), 'error');
                resetButton();
                return;
            }
            
            // Timeout check
            if (currentAttempt >= maxAttempts) {
                clearInterval(pollInterval);
                showResponseCard('Response generation is taking longer than expected. Please check the "Responded Emails" section.', 'warning');
                resetButton();
            }
            
        } catch (error) {
            console.error('Polling error:', error);
        }
    }, interval);
}

function showResponseCard(content, status = 'success') {
    const responseCard = document.getElementById('responseCard');
    const responseContent = document.getElementById('responseContent');
    const responseStatus = document.getElementById('responseStatus');
    
    responseContent.textContent = content;
    responseCard.style.display = 'block';
    
    // Update status
    responseStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
    responseStatus.className = 'response-status status-' + status;
    
    // Scroll to response
    responseCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function updateResponseStatus(status) {
    const statusElement = document.getElementById('responseStatus');
    if (statusElement) {
        statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1).replace(/_/g, ' ');
    }
}

// Generate follow-ups when user clicks the button
async function generateFollowUps() {
    const followupBtn = document.getElementById('followupBtn');
    const originalText = followupBtn.innerHTML;
    
    followupBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    followupBtn.disabled = true;
    
    try {
        // Simulate API call to generate follow-ups
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Show the follow-up section with generated content
        showFollowupSection();
        
        showNotification('Follow-up sequence generated!', 'success');
        
    } catch (error) {
        console.error('Error generating follow-ups:', error);
        showNotification('Error generating follow-ups. Please try again.', 'error');
    } finally {
        followupBtn.innerHTML = originalText;
        followupBtn.disabled = false;
    }
}

function showFollowupSection() {
    const followupSection = document.getElementById('followupSection');
    const followupList = document.getElementById('followupList');
    
    // Sample follow-up data - in real implementation, this would come from your AI
    const followUps = [
        {
            day: 'Immediate',
            date: 'Now',
            content: `Hi [Sender Name], thank you for your inquiry about [property]. I'd be happy to provide you with all the details you requested. When would be a good time to connect?`
        },
        {
            day: 'Day 1',
            date: 'Tomorrow',
            content: `Following up on my previous email - did you have a chance to review the information? I'm available to answer any questions you might have about the property.`
        },
        {
            day: 'Day 3',
            date: 'In 3 days',
            content: `Just checking in to see if you had any thoughts on the [property] details I shared. Would you like to schedule a quick call to discuss this further?`
        },
        {
            day: 'Day 7',
            date: 'In 1 week',
            content: `Wanted to follow up one more time about the [property]. We're seeing strong interest in this listing, so let me know if you'd like to move forward with a viewing.`
        },
        {
            day: 'Day 14',
            date: 'In 2 weeks',
            content: `Hope you're having a great week! I wanted to see if your team is still considering the [property] opportunity. Happy to provide any additional information you might need.`
        },
        {
            day: 'Day 30',
            date: 'In 1 month',
            content: `Touching base regarding your initial interest in [property]. The market remains active, and I wanted to see if this is still on your radar. We have some new comps that might be of interest.`
        }
    ];
    
    followupList.innerHTML = followUps.map((followup, index) => `
        <div class="followup-item">
            <div class="followup-header-row" onclick="toggleFollowupContent(${index})">
                <div class="followup-meta">
                    <div class="followup-day">${followup.day}</div>
                    <div class="followup-date">${followup.date}</div>
                </div>
                <div class="followup-status">Preview</div>
            </div>
            <div class="followup-content" id="followup-content-${index}">
                ${followup.content}
            </div>
        </div>
    `).join('');
    
    followupSection.style.display = 'block';
    
    // Scroll to follow-up section
    followupSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function toggleFollowupContent(index) {
    const content = document.getElementById(`followup-content-${index}`);
    content.classList.toggle('expanded');
}

async function saveFollowUps() {
    const saveBtn = document.getElementById('saveFollowupsBtn');
    const originalText = saveBtn.innerHTML;
    
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;
    
    try {
        // Get form data
        const senderEmail = document.getElementById('sender_email').value;
        const senderName = document.getElementById('sender_name').value;
        const subject = document.getElementById('subject').value;
        
        // In real implementation, you would send this data to your backend
        // to create a lead record and schedule the follow-ups
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        showNotification('Follow-up sequence saved! The lead has been added to your pipeline.', 'success');
        
        // Update button to show success
        saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved!';
        saveBtn.style.background = 'linear-gradient(135deg, #64ffda 0%, #52d1b8 100%)';
        saveBtn.style.color = '#0a192f';
        
    } catch (error) {
        console.error('Error saving follow-ups:', error);
        showNotification('Error saving follow-ups. Please try again.', 'error');
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

function copyResponse() {
    const responseContent = document.getElementById('responseContent');
    const text = responseContent.textContent;
    
    navigator.clipboard.writeText(text).then(() => {
        showNotification('Response copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Failed to copy: ', err);
        showNotification('Failed to copy. Please select and copy manually.', 'error');
    });
}

async function sendResponse() {
    const responseContent = document.getElementById('responseContent');
    const senderEmail = document.getElementById('sender_email').value;
    const subject = document.getElementById('subject').value;
    const content = responseContent.textContent;
    
    if (!content || content === 'Response generated successfully.') {
        showNotification('No response content to send.', 'error');
        return;
    }
    
    try {
        const sendBtn = document.getElementById('sendBtn');
        const originalText = sendBtn.innerHTML;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
        sendBtn.disabled = true;
        
        // Here you would integrate with your Gmail sending endpoint
        // For now, we'll simulate success
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        showNotification('Response sent via Gmail successfully!', 'success');
        sendBtn.innerHTML = '<i class="fas fa-check"></i> Sent!';
        
    } catch (error) {
        console.error('Error sending email:', error);
        showNotification('Error sending email. Please copy and send manually.', 'error');
        
        const sendBtn = document.getElementById('sendBtn');
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send via Gmail';
        sendBtn.disabled = false;
    }
}

function clearForm() {
    document.getElementById('manualEmailForm').reset();
    showNotification('Form cleared!', 'success');
}

function resetForm() {
    clearForm();
    document.getElementById('responseCard').style.display = 'none';
    document.getElementById('followupSection').style.display = 'none';
    document.getElementById('sendBtn').style.display = 'none';
    document.getElementById('followupBtn').style.display = 'none';
    
    // Reset followup button
    const followupBtn = document.getElementById('followupBtn');
    followupBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Generate Follow-ups';
    followupBtn.disabled = false;
    
    // Reset save button
    const saveBtn = document.getElementById('saveFollowupsBtn');
    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Follow-up Sequence';
    saveBtn.style.background = '';
    saveBtn.style.color = '';
    saveBtn.disabled = false;
    
    document.getElementById('manualEmailForm').scrollIntoView({ behavior: 'smooth' });
    showNotification('Ready for new email!', 'success');
}

// Notification system
function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => notification.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas fa-${getNotificationIcon(type)}"></i>
            <span>${message}</span>
        </div>
    `;
    
    // Add styles if not already added
    if (!document.querySelector('#notification-styles')) {
        const styles = document.createElement('style');
        styles.id = 'notification-styles';
        styles.textContent = `
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                animation: slideInRight 0.3s ease;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }
            .notification-success { background: linear-gradient(135deg, #64ffda 0%, #52d1b8 100%); color: #0a192f; }
            .notification-error { background: linear-gradient(135deg, #f72585 0%, #b5179e 100%); }
            .notification-warning { background: linear-gradient(135deg, #f8961e 0%, #f3722c 100%); }
            .notification-info { background: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%); }
            .notification-content { display: flex; align-items: center; gap: 0.5rem; }
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(styles);
    }
    
    document.body.appendChild(notification);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.animation = 'slideInRight 0.3s ease reverse';
            setTimeout(() => notification.remove(), 300);
        }
    }, 3000);
}

function getNotificationIcon(type) {
    const icons = {
        success: 'check-circle',
        error: 'exclamation-circle',
        warning: 'exclamation-triangle',
        info: 'info-circle'
    };
    return icons[type] || 'info-circle';
}

function resetButton() {
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.innerHTML = '<i class="fas fa-robot"></i> Generate AI Response';
    submitBtn.disabled = false;
}

// Initialize form with some helpful defaults
document.addEventListener('DOMContentLoaded', function() {
    // Auto-focus the first input
    const firstInput = document.querySelector('#sender_email');
    if (firstInput) {
        setTimeout(() => firstInput.focus(), 100);
    }
    
    // Add input validation
    const inputs = document.querySelectorAll('input[required], textarea[required]');
    inputs.forEach(input => {
        input.addEventListener('invalid', function() {
            this.style.borderColor = '#f72585';
            showNotification('Please fill in all required fields.', 'error');
        });
        
        input.addEventListener('input', function() {
            if (this.checkValidity()) {
                this.style.borderColor = '#64ffda';
            }
        });
    });
});
</script>
